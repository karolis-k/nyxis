name: Deploy - Android & Web

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      deploy_android:
        description: 'Deploy Android APK'
        required: false
        default: true
        type: boolean
      deploy_web:
        description: 'Deploy Web App'
        required: false
        default: true
        type: boolean
      remote_name:
        description: 'Rclone remote name'
        required: false
        default: 'mydrive'
        type: string
      remote_folder:
        description: 'Remote folder name'
        required: false
        default: 'Nyxis'
        type: string

# Permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "deploy"
  cancel-in-progress: false

jobs:
  build-android:
    if: github.event.inputs.deploy_android != 'false'
    runs-on: windows-latest
    timeout-minutes: 45
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.1'
          channel: 'stable'
          cache: true

      - name: Clean Flutter cache
        run: flutter clean
        
      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-home-cache-cleanup: true

      - name: Install rclone
        shell: powershell
        run: |
          Write-Host "Installing rclone via chocolatey..."
          choco install rclone -y --no-progress
          rclone version

      - name: Configure rclone
        shell: powershell
        env:
          RCLONE_CONF: ${{ secrets.RCLONE_CONF }}
          RCLONE_DRIVE_ROOT_ID: ${{ secrets.RCLONE_DRIVE_ROOT_ID }}
        run: |
          $configDir = "$env:APPDATA\rclone"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          $env:RCLONE_CONF | Out-File -FilePath "$configDir\rclone.conf" -Encoding UTF8
          rclone listremotes

      - name: Build and Upload APK
        shell: cmd
        env:
          RCLONE_DRIVE_ROOT_ID: ${{ secrets.RCLONE_DRIVE_ROOT_ID }}
        run: scripts\build_and_upload.bat ${{ github.event.inputs.remote_name || 'mydrive' }} ${{ github.event.inputs.remote_folder || 'Nyxis' }}

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-build-logs-${{ github.run_number }}
          path: build_logs/
          retention-days: 30

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: android-apk-${{ github.run_number }}
          path: build/app/outputs/flutter-apk/app-*-debug.apk
          retention-days: 90

  build-web:
    if: github.event_name == 'push' || github.event.inputs.deploy_web != 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.1'
          channel: 'stable'
          cache: true

      - name: Clean Flutter cache
        run: flutter clean
        
      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build web app
        run: flutter build web --release --base-href="/nyxis/"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload web artifact for Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'build/web'

      - name: Upload web build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build-${{ github.run_number }}
          path: build/web/
          retention-days: 90

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


  notify-results:
    runs-on: ubuntu-latest
    needs: [build-android, build-web]
    if: always()
    steps:
      - name: Create deployment summary
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            let summary = `# üöÄ Deployment Results\n\n`;
            
            // Android results
            if ('${{ github.event.inputs.deploy_android }}' !== 'false') {
              if ('${{ needs.build-android.result }}' === 'success') {
                summary += `‚úÖ **Android APK**: Built and uploaded successfully\n`;
                summary += `üì± APK available on Google Drive and GitHub Actions\n\n`;
              } else {
                summary += `‚ùå **Android APK**: Build failed\n\n`;
              }
            }
            
            // Web results  
            if ('${{ github.event_name }}' === 'push' || '${{ github.event.inputs.deploy_web }}' !== 'false') {
              if ('${{ needs.build-web.result }}' === 'success') {
                summary += `‚úÖ **Web App**: Built and deployed successfully\n`;
                summary += `üåê Live at: https://karolis-k.github.io/nyxis/\n\n`;
              } else {
                summary += `‚ùå **Web App**: Build/deployment failed\n\n`;
              }
            }
            
            summary += `üîó [View full run details](${runUrl})`;
            
            await core.summary.addRaw(summary).write();
